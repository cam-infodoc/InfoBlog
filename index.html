<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Info-Blog</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Montserrat', sans-serif;
    background-color: #000;
    color: #fff;
    margin: 0;
    padding: 0;
  }
  h1 {
    text-align: center;
    margin: 20px 0;
  }
  #articles-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    padding: 20px;
  }
  .article-card {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 0 20px rgba(0,150,255,0.2);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .article-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  .read-more {
    display: inline-block;
    margin-top: 10px;
    color: #00f;
    cursor: pointer;
    text-decoration: underline;
  }
  .like-btn {
    font-size: 20px;
    cursor: pointer;
    margin-left: 10px;
  }
  #modal {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  #modal-content {
    background: rgba(255,255,255,0.05);
    padding: 20px;
    border-radius: 12px;
    max-width: 700px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
  }
  #modal-close {
    cursor: pointer;
    color: #00f;
    float: right;
    font-weight: bold;
  }
</style>
</head>
<body>
<h1>ðŸ’¬ Info-Blog</h1>
<div id="articles-container"></div>

<!-- Modal -->
<div id="modal">
  <div id="modal-content">
    <span id="modal-close">âœ–</span>
    <div id="modal-text"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAjmG6LJRj-qWcDUuQc8PJy16e5RgvAE7s",
    authDomain: "info-blog-151fb.firebaseapp.com",
    projectId: "info-blog-151fb",
    storageBucket: "info-blog-151fb.firebasestorage.app",
    messagingSenderId: "913242123335",
    appId: "1:913242123335:web:9305575bb83355380a9562"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const collectionName = "articles-blog";

  const container = document.getElementById("articles-container");
  const modal = document.getElementById("modal");
  const modalText = document.getElementById("modal-text");
  const modalClose = document.getElementById("modal-close");

  modalClose.onclick = () => { modal.style.display = "none"; };

  let lastVisible = null;
  const pageSize = 6;
  let loading = false;
  let allLoaded = false;

  function renderArticle(doc) {
    const data = doc.data();
    const card = document.createElement("div");
    card.className = "article-card";
    card.innerHTML = `
      <h2>${data.titre}</h2>
      ${data.image ? `<img src="${data.image}" alt="illustration">` : ''}
      <p>${data.extrait || ''}</p>
      <span class="read-more">Lire la suite</span>
      <div>
        <span class="like-btn">â™¡</span>
        <span class="like-count">${data.likes || 0}</span>
      </div>
    `;
    container.appendChild(card);

    const readMore = card.querySelector(".read-more");
    const likeBtn = card.querySelector(".like-btn");
    const likeCount = card.querySelector(".like-count");
    const currentDocId = doc.id;

    // ðŸ”¹ Ouvre un PDF ou affiche le contenu
    readMore.onclick = () => {
      if (data.contenu && data.contenu.toLowerCase().endsWith(".pdf")) {
        window.open(data.contenu, "_blank");
      } else {
        modalText.textContent = data.contenu || "Pas de contenu disponible.";
        modal.style.display = "flex";
      }
    };

    // ðŸ”¹ VÃ©rifie si dÃ©jÃ  likÃ©
    if (localStorage.getItem("liked_" + currentDocId)) {
      likeBtn.textContent = "â¤ï¸";
    }

    likeBtn.onclick = async () => {
      const hasLiked = localStorage.getItem("liked_" + currentDocId);
      const docRef = db.collection(collectionName).doc(currentDocId);
      if (hasLiked) {
        await docRef.update({ likes: firebase.firestore.FieldValue.increment(-1) });
        likeBtn.textContent = "â™¡";
        likeCount.textContent = parseInt(likeCount.textContent) - 1;
        localStorage.removeItem("liked_" + currentDocId);
      } else {
        await docRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
        likeBtn.textContent = "â¤ï¸";
        likeCount.textContent = parseInt(likeCount.textContent) + 1;
        localStorage.setItem("liked_" + currentDocId, true);
      }
    };
  }

  async function loadArticlesBatch() {
    if (loading || allLoaded) return;
    loading = true;

    let query = db.collection(collectionName)
                  .orderBy(firebase.firestore.FieldPath.documentId())
                  .limit(pageSize);
    if (lastVisible) query = query.startAfter(lastVisible);

    const snapshot = await query.get();
    if (snapshot.empty) {
      allLoaded = true;
      return;
    }

    lastVisible = snapshot.docs[snapshot.docs.length - 1];
    snapshot.forEach(doc => renderArticle(doc));
    loading = false;

    // Stop le scroll s'il n'y a plus rien
    if (snapshot.size < pageSize) allLoaded = true;
  }

  // âœ… Charge la premiÃ¨re sÃ©rie d'articles
  loadArticlesBatch();

  // âœ… Ajoute le scroll infini
  window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
      loadArticlesBatch();
    }
  });
</script>
</body>
</html>
